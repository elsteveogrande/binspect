#!/usr/bin/env bash

if [[ ! -d include ]] ; then
  echo "chdir to project root, then run as: scripts/t"
  exit 1
fi

CC=${CC:-clang++}
TESTCC=test/test_binspect.cc
BUILD=build
OPT=${OPT:-Og}
SAN=${SAN:address}
PROG=${PROG:-$BUILD/test}

set -xeuo pipefail

mkdir -p build

if [[ ! -z $SAN ]]; then
  FSAN="-fsanitize=${SAN}"
else
  FSAN=''
fi

if [[ $CC =~ "clang" ]]; then STDCXX=libc++; else STDCXX=libstdc++; fi

"${CC}"                         \
  @compile_flags.txt            \
  -g                            \
  "-${OPT}"                     \
  -o "${PROG}"                  \
  ${FSAN}                       \
  -stdlib="${STDCXX}"           \
  -UNDEBUG                      \
  "${TESTCC}"
